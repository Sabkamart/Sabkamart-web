<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Own Item - Fixed</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      margin: 0;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .category-box {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }

    .category-box select {
      padding: 10px 14px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f9f9f9;
      min-width: 180px;
      cursor: pointer;
      height: 42px;
      box-sizing: border-box;
    }

    .container {
      width: 400px;
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background-color: #fff;
    }

    .radio-group {
      display: flex;
      justify-content: space-around;
      margin-bottom: 15px;
    }

    .radio-group input {
      margin-right: 5px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    input[type="text"],
    input[type="number"],
    input[type="file"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .quantity-group {
      display: flex;
      gap: 10px;
    }

    .quantity-group input {
      flex: 1;
    }

    #unit {
      width: 50%;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #ccc;
      color: #555;
      background-color: #fff;
    }

    .image-upload {
      margin-bottom: 15px;
    }

    .image-upload label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .image-preview {
      margin-top: 10px;
      text-align: center;
    }

    .image-preview img {
      max-width: 200px;
      max-height: 200px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }

    .btn-save {
      width: 100%;
      padding: 12px;
      background-color: #ffc107;
      border: none;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .btn-save:hover {
      background-color: #e0a800;
    }

    .btn-save:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .alert {
      margin-top: 15px;
      padding: 12px;
      border-radius: 4px;
      font-weight: bold;
      display: none;
    }

    .alert.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert.loading {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .select2-container {
      min-width: 180px !important;
      box-sizing: border-box;
    }

    .select2-container--default .select2-selection--single {
      font-size: 16px !important;
      border: 1px solid #ccc !important;
      border-radius: 8px !important;
      background: #f9f9f9 !important;
      cursor: pointer;
      height: 42px !important;
      box-sizing: border-box !important;
      padding: 0 !important;
      line-height: 42px !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
      padding-left: 12px !important;
      padding-right: 30px !important;
      line-height: 42px !important;
      color: #333 !important;
      margin: 0 !important;
      height: 42px !important;
      display: block !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 42px !important;
      top: 0 !important;
      right: 8px !important;
      width: 20px !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow b {
      top: 50% !important;
      transform: translateY(-50%) !important;
    }

    .select2-container--default.select2-container--disabled .select2-selection--single {
      background-color: #e9ecef;
      cursor: not-allowed;
      color: #6c757d;
    }

    .select2-container {
      z-index: 9999 !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__placeholder {
      color: #6c757d;
    }

    .file-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .debug-info {
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-width: 400px;
      word-wrap: break-word;
      max-height: 300px;
      overflow-y: auto;
    }

    .test-button {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .test-button:hover {
      background-color: #0056b3;
    }

    .test-button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .url-input {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
    }

    .connection-status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-weight: bold;
      text-align: center;
    }

    .status-unknown {
      background-color: #e9ecef;
      color: #495057;
    }

    .status-connected {
      background-color: #d4edda;
      color: #155724;
    }

    .status-error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .url-validator {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .url-validator h4 {
      margin: 0 0 10px 0;
      color: #495057;
    }

    .url-check {
      display: flex;
      align-items: center;
      margin: 5px 0;
      font-size: 14px;
    }

    .check-icon {
      margin-right: 8px;
      font-weight: bold;
    }

    .check-pass {
      color: #28a745;
    }

    .check-fail {
      color: #dc3545;
    }

    .check-warning {
      color: #ffc107;
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>

<form id="productForm">
  <div class="category-box">
    <select name="category" id="category" required>
      <option value="">Select Category</option>
      <option value="Kitchen & Grocery">Kitchen & Grocery</option>
      <option value="Household Essentials">Household Essentials</option>
      <option value="Snacks & Drinks">Snacks & Drinks</option>
      <option value="Other Home Needs">Other Home Needs</option>
      <option value="Stationary">Stationary</option>
    </select>

    <select name="subcategory" id="subcategory" disabled required>
      <option value="">Select SubCategory</option>
    </select>
  </div>

  <div class="container">
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status status-unknown">
      Connection Status: Unknown
    </div>

    <!-- Script URL Input -->
    <input type="text" id="scriptUrl" class="url-input" 
           placeholder="Enter your Google Apps Script URL here"
           value="">

    <!-- URL Validator -->
    <div id="urlValidator" class="url-validator" style="display: none;">
      <h4>URL Validation:</h4>
      <div id="urlChecks"></div>
    </div>

    <button type="button" class="test-button" id="testBtn">Test Connection</button>

    <div class="radio-group">
      <label><input type="radio" name="itemType" value="brand" required> Brand Item</label>
      <label><input type="radio" name="itemType" value="loose" required> Loose Item</label>
    </div>

    <div class="form-group">
      <input type="text" name="barcode" id="barcode" placeholder="BarCode Number" required>
    </div>
    <div class="form-group">
      <input type="text" name="brand" id="brand" placeholder="Enter Brand Name" required>
    </div>
    <div class="form-group">
      <input type="text" name="product" id="product" placeholder="Enter Product Full Name" required>
    </div>

    <div class="form-group quantity-group">
      <input type="text" name="quantity" id="quantity" placeholder="Enter Quantity" required>
      <select name="unit" id="unit" required>
        <option value="">Select Unit</option>
        <option value="Kg">Kg</option>
        <option value="g">g</option>
        <option value="L">L</option>
        <option value="ml">ml</option>
        <option value="Pieces">Pieces</option>
        <option value="Combo">Combo</option>
        <option value="Pack">Pack</option>
        <option value="Sheets">Sheets</option>
      </select>
    </div>

    <div class="form-group image-upload">
      <label for="imageFile">Product Image (Optional):</label>
      <input type="file" name="imageFile" id="imageFile" accept="image/*">
      <div class="file-info">Supported formats: JPG, PNG, GIF. Max size: 5MB</div>
      <div id="imagePreview" class="image-preview"></div>
    </div>

    <button type="submit" class="btn-save" id="saveBtn">Submit</button>
    
    <div id="alertBox" class="alert"></div>
    <div id="debugInfo" class="debug-info" style="display: none;"></div>
  </div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  // Category to Subcategory mapping
  const categoryMap = {
    "Household Essentials": ["Toilet Cleaners", "Floor Cleaners", "Soaps", "Face Creams", "Shampoo", "Tooth Paste", "Hair Oil", "Body Lotion", "Detergent Powder", "Basic Pharma", "Handwash & Sanitizer", "Hair Removals", "Sanitary Pads", "Tooth Brush", "Detergent Bars", "Fabric Care", "Conditioner", "Body Washes", "Face Powders", "Face Wash & Scrub", "Liquid Detergents", "Utensils Cleaners", "Baby Care"],
    "Kitchen & Grocery": ["Ground Nut", "Toor Dal", "Honey", "Wheat Flour", "Tea Powder", "Local Rice", "Dry Coconut", "Jaggery", "Salt", "Sugar", "Basmati Rice", "Semiya", "Garlic", "Eggs", "Tamarind", "Ghee", "Red Mirchi", "Tumeric", "Chicken & Garam Masala", "Ginger Garlic Paste", "Other Masalas", "Dates", "Cashew Nuts", "Almond & Pista", "Raisins", "Other Dry Fruits", "Mango", "Lemon & Tomato", "Other Pickles", "Sunflower Oil", "Groundnut Oil", "Coffee Powder", "Healthy Drinks", "Other Oils", "Papads", "Poha", "Gram Flour", "Maida", "Other Flours", "Chana Dal", "Phutana", "Other Dals", "Upma Rava", "Idli Rava", "Bombay Rava", "Baking Soda", "Jeera", "Jeera & Mustard Seeds", "Dalchini Sticks & Somp", "Coriander & Pepper seeds", "Other Spi", "Milk Maid", "Gulab Jamun", "Saffron", "Peni Rava", "Other Sweets", "Oats"],
    "Other Home Needs": ["Cloth Clips", "Battery Cell", "Betel Nut", "Rangoli Powder", "CowDung Powder", "Ear Buds", "Toothpick Sticks", "Mouth Freshner", "Candles", "Match Box", "Plastic Bag", "Tissue Papers", "Agarbatti", "Coconut", "Camphor & Sambrani", "Kumkum & Vibhuti", "Deepa Oil & Diyabatti", "Broom", "Mop", "Home", "Bathroom", "Mosquito", "Cockroach", "Rat", "Ant", "Other", "Plates", "Glasses", "Cups & Spoons", "Paper Rolls", "Aluminium Foil", "Foil Container"],
    "Snacks & Drinks": ["Soft Drinks", "Cookies", "Chips", "Tubs & Party Packs", "Pasta", "Bhujia & Namkeens", "Indian Snacks", "Sweets", "Jam", "Ketchup", "Spreads & Dips", "Instant Noodles", "Cup Noodles", "Korean Noodles", "Hakka Noodles", "Other Noodles", "Energy Drinks", "Juices & Fruit Drinks", "Cones & Sticks", "Kulfi", "Cups", "Other Ice Creams", "Soups", "Cheese", "Butter", "Paneer", "Buns", "Cadbury", "Nestle", "Amul", "Other Chocolates", "Marie & Digestive", "Cream Biscuits", "Cakes & Pies", "Rusk"],
    "Stationary": ["Books", "Fevi Sticks & Gums", "Stapler & Pins", "Cello Tape", "Chalks", "Pens & Pencils", "Sketch Pens & Glitters", "Files", "Geometry Box", "Exam Pad", "Color Pens & Paint", "Pen Holder"]
  };

  const elements = {
    alertBox: document.getElementById('alertBox'),
    saveBtn: document.getElementById('saveBtn'),
    testBtn: document.getElementById('testBtn'),
    imageInput: document.getElementById('imageFile'),
    imagePreview: document.getElementById('imagePreview'),
    debugInfo: document.getElementById('debugInfo'),
    scriptUrl: document.getElementById('scriptUrl'),
    connectionStatus: document.getElementById('connectionStatus'),
    urlValidator: document.getElementById('urlValidator'),
    urlChecks: document.getElementById('urlChecks')
  };

  let isConnected = false;

  function getScriptUrl() {
    return elements.scriptUrl.value.trim();
  }

  function validateUrl(url) {
    const checks = [];
    
    // Check if URL is provided
    if (!url) {
      checks.push({
        status: 'fail',
        message: 'URL is required'
      });
      return checks;
    }

    // Check if URL starts with https://script.google.com
    if (!url.startsWith('https://script.google.com/macros/s/')) {
      checks.push({
        status: 'fail',
        message: 'URL must start with https://script.google.com/macros/s/'
      });
    } else {
      checks.push({
        status: 'pass',
        message: 'URL starts with correct domain'
      });
    }

    // Check if URL ends with /exec
    if (!url.endsWith('/exec')) {
      checks.push({
        status: 'fail',
        message: 'URL must end with /exec'
      });
    } else {
      checks.push({
        status: 'pass',
        message: 'URL ends with /exec'
      });
    }

    // Check URL length (should be reasonable)
    if (url.length < 50) {
      checks.push({
        status: 'warning',
        message: 'URL seems too short - verify it\'s complete'
      });
    } else {
      checks.push({
        status: 'pass',
        message: 'URL length appears correct'
      });
    }

    return checks;
  }

  function displayUrlValidation(url) {
    const checks = validateUrl(url);
    elements.urlChecks.innerHTML = '';
    
    checks.forEach(check => {
      const checkDiv = document.createElement('div');
      checkDiv.className = 'url-check';
      
      const icon = document.createElement('span');
      icon.className = `check-icon check-${check.status}`;
      icon.textContent = check.status === 'pass' ? '✓' : 
                        check.status === 'warning' ? '⚠' : '✗';
      
      const message = document.createElement('span');
      message.textContent = check.message;
      
      checkDiv.appendChild(icon);
      checkDiv.appendChild(message);
      elements.urlChecks.appendChild(checkDiv);
    });
    
    elements.urlValidator.style.display = 'block';
  }

  // Validate URL when typing
  elements.scriptUrl.addEventListener('input', function() {
    const url = this.value.trim();
    if (url) {
      displayUrlValidation(url);
    } else {
      elements.urlValidator.style.display = 'none';
    }
    
    // Reset connection status when URL changes
    isConnected = false;
    updateConnectionStatus('unknown', 'Connection Status: Unknown');
  });

  function updateConnectionStatus(status, message) {
    elements.connectionStatus.className = `connection-status status-${status}`;
    elements.connectionStatus.textContent = message;
    isConnected = (status === 'connected');
  }

  function showAlert(message, type) {
    elements.alertBox.className = `alert ${type}`;
    elements.alertBox.textContent = message;
    elements.alertBox.style.display = 'block';
    
    if (type === 'success') {
      setTimeout(() => {
        elements.alertBox.style.display = 'none';
      }, 5000);
    }
  }

  function logDebug(message) {
    console.log(message);
    const timestamp = new Date().toLocaleTimeString();
    const existingContent = elements.debugInfo.innerHTML;
    elements.debugInfo.innerHTML = existingContent + '<br>' + timestamp + ': ' + message;
    elements.debugInfo.style.display = 'block';
  }

  function clearDebug() {
    elements.debugInfo.innerHTML = '';
    elements.debugInfo.style.display = 'none';
  }

  // Test connection with better error handling
  elements.testBtn.addEventListener('click', async function() {
    const scriptUrl = getScriptUrl();
    
    if (!scriptUrl) {
      showAlert('Please enter your Google Apps Script URL first', 'error');
      return;
    }

    // Validate URL format first
    const urlChecks = validateUrl(scriptUrl);
    const hasFailures = urlChecks.some(check => check.status === 'fail');
    
    if (hasFailures) {
      showAlert('Please fix the URL format issues before testing', 'error');
      displayUrlValidation(scriptUrl);
      return;
    }

    elements.testBtn.disabled = true;
    elements.testBtn.textContent = 'Testing...';
    showAlert('Testing connection...', 'loading');
    clearDebug();
    
    try {
      logDebug('Testing connection to: ' + scriptUrl);
      updateConnectionStatus('unknown', 'Testing connection...');
      
      // Test with a timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
      
      const response = await fetch(scriptUrl, {
        method: 'GET',
        signal: controller.signal,
        mode: 'cors',
        headers: {
          'Accept': 'application/json',
        }
      });
      
      clearTimeout(timeoutId);
      logDebug('Response received. Status: ' + response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      logDebug('Response data: ' + JSON.stringify(result));
      
      if (result.status === 'active') {
        showAlert('✓ Connection successful! API is working.', 'success');
        updateConnectionStatus('connected', '✓ Connected - Ready to submit data');
        logDebug('Connection test PASSED');
        
        // Show additional success info
        if (result.sheetName) {
          logDebug('Connected to sheet: ' + result.sheetName);
        }
        if (result.folderName) {
          logDebug('Connected to folder: ' + result.folderName);
        }
      } else {
        showAlert('Connection established but unexpected response', 'error');
        updateConnectionStatus('error', '⚠ Connected but unexpected response');
        logDebug('Unexpected response: ' + JSON.stringify(result));
      }
      
    } catch (error) {
      console.error('Connection test failed:', error);
      logDebug('Connection test FAILED: ' + error.message);
      updateConnectionStatus('error', '✗ Connection failed');
      
      if (error.name === 'AbortError') {
        showAlert('Connection test timed out (15 seconds)', 'error');
        logDebug('Request timed out after 15 seconds');
      } else if (error.message.includes('Failed to fetch')) {
        showAlert('Network error - Check your URL and script deployment', 'error');
        logDebug('Network error - possible CORS or deployment issue');
      } else {
        showAlert('Connection test failed: ' + error.message, 'error');
      }
      
      // Show detailed troubleshooting
      setTimeout(() => {
        elements.debugInfo.innerHTML += `
          <br><br><strong>Troubleshooting Steps:</strong><br>
          1. ✓ Verify your Google Apps Script URL is correct<br>
          2. ✓ Make sure script is deployed as Web App<br>
          3. ✓ Set access to "Anyone" in deployment settings<br>
          4. ✓ Try opening URL directly: <a href="${scriptUrl}" target="_blank">Test URL</a><br>
          5. ✓ Check Google Apps Script execution logs<br>
          6. ✓ Verify your Google Sheets ID and Drive Folder ID in the script<br><br>
          <strong>Common Issues:</strong><br>
          • Script not deployed or deployment outdated<br>
          • Wrong access permissions (should be "Anyone")<br>
          • Incorrect Sheet ID or Drive Folder ID<br>
          • Network/firewall blocking the request<br>
          • Script has errors - check Apps Script logs
        `;
      }, 100);
      
    } finally {
      elements.testBtn.disabled = false;
      elements.testBtn.textContent = 'Test Connection';
    }
  });

  // Image preview functionality
  elements.imageInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    elements.imagePreview.innerHTML = '';
    
    if (file) {
      // Validate file size (5MB limit)
      if (file.size > 5 * 1024 * 1024) {
        showAlert('Image size must be less than 5MB', 'error');
        elements.imageInput.value = '';
        return;
      }
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showAlert('Please select a valid image file', 'error');
        elements.imageInput.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        elements.imagePreview.appendChild(img);
      };
      reader.readAsDataURL(file);
    }
  });

  // Convert file to base64
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = error => reject(error);
    });
  }

  // Form validation
  function validateForm(formData) {
    const requiredFields = ['category', 'subcategory', 'itemType', 'barcode', 'brand', 'product', 'quantity', 'unit'];
    
    for (let field of requiredFields) {
      if (!formData.get(field) || formData.get(field).trim() === '') {
        showAlert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field`, 'error');
        return false;
      }
    }
    return true;
  }

  // Initialize when DOM is ready
  $(document).ready(function() {
    // Initialize Select2 for subcategory
    $('#subcategory').select2({
      placeholder: 'Select SubCategory',
      allowClear: false,
      width: '100%'
    });

    // Category change handler
    $('#category').on('change', function() {
      const selectedCategory = $(this).val();
      
      // Clear subcategory dropdown
      $('#subcategory').empty().append('<option value="">Select SubCategory</option>');
      
      if (selectedCategory && categoryMap[selectedCategory]) {
        // Enable subcategory dropdown
        $('#subcategory').prop('disabled', false);
        
        // Add subcategory options
        categoryMap[selectedCategory].forEach(function(subcategory) {
          $('#subcategory').append(new Option(subcategory, subcategory));
        });
      } else {
        // Disable subcategory dropdown
        $('#subcategory').prop('disabled', true);
      }
      
      // Refresh Select2
      $('#subcategory').trigger('change');
    });
  });

  // Form submission with improved error handling
  document.getElementById('productForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    
    const scriptUrl = getScriptUrl();
    if (!scriptUrl) {
      showAlert('Please enter your Google Apps Script URL first', 'error');
      return;
    }

    if (!isConnected) {
      showAlert('Please test connection first to ensure the API is working', 'error');
      return;
    }
    
    const formData = new FormData(this);
    
    if (!validateForm(formData)) {
      return;
    }

    elements.saveBtn.disabled = true;
    elements.saveBtn.textContent = 'Saving...';
    showAlert('Saving product...', 'loading');
    clearDebug();
    logDebug('Starting form submission...');

    try {
      // Prepare data object
      const data = {
        category: formData.get('category'),
        subcategory: formData.get('subcategory'),
        itemType: formData.get('itemType'),
        barcode: formData.get('barcode'),
        brand: formData.get('brand'),
        product: formData.get('product'),
        quantity: formData.get('quantity'),
        unit: formData.get('unit'),
        timestamp: new Date().toISOString()
      };

      logDebug('Form data prepared: ' + JSON.stringify(data));

      // Handle image upload if present
      const imageFile = elements.imageInput.files[0];
      if (imageFile) {
        try {
          logDebug('Processing image: ' + imageFile.name + ' (' + imageFile.size + ' bytes)');
          const base64Data = await fileToBase64(imageFile);
          data.image = {
            name: imageFile.name,
            data: base64Data,
            mimeType: imageFile.type
          };
          logDebug('Image converted to base64 successfully');
        } catch (imageError) {
          console.error('Error processing image:', imageError);
          logDebug('Image processing failed: ' + imageError.message);
          showAlert('Error processing image, continuing without image', 'error');
        }
      }

      logDebug('Sending POST request to: ' + scriptUrl);

      // Send data with timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

      const response = await fetch(scriptUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
        signal: controller.signal,
        mode: 'cors'
      });

      clearTimeout(timeoutId);
      logDebug('Response received, status: ' + response.status);

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();
      logDebug('Response data: ' + JSON.stringify(result));
      
      if (result.success) {
        showAlert(result.message || 'Product saved successfully!', 'success');
        logDebug('Form submission successful!');
        
        // Reset form
        document.getElementById('productForm').reset();
        $('#subcategory').empty().append('<option value="">Select SubCategory</option>');
        $('#subcategory').prop('disabled', true).trigger('change');
        elements.imagePreview.innerHTML = '';
        
        if (result.imageUrl) {
          logDebug('Image uploaded: ' + result.imageName);
        }
        if (result.rowNumber) {
          logDebug('Data saved to row: ' + result.rowNumber);
        }
      } else {
        showAlert(result.message || 'Error saving product', 'error');
        logDebug('Server returned error: ' + (result.message || 'Unknown error'));
        if (result.error) {
          logDebug('Detailed error: ' + result.error);
        }
      }

    } catch (error) {
      console.error('Submission error:', error);
      logDebug('Submission failed: ' + error.message);
      
      if (error.name === 'AbortError') {
        showAlert('Request timed out. Please try again.', 'error');
        logDebug('Form submission timed out after 30 seconds');
      } else if (error.message.includes('Failed to fetch')) {
        showAlert('Network error. Check your connection and try again.', 'error');
        logDebug('Network error during form submission');
        updateConnectionStatus('error', '✗ Connection lost');
      } else {
        showAlert(`Error saving product: ${error.message}`, 'error');
      }
      
    } finally {
      elements.saveBtn.disabled = false;
      elements.saveBtn.textContent = 'Submit';
    }
  });

</script>

</body>
</html>